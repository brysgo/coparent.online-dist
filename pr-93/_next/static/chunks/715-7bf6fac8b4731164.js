"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[715],{844:(e,t,s)=>{s.d(t,{GY:()=>u,h9:()=>n,hV:()=>o});var r=s(9509);function a(){let e=i();return"main"===e||"master"===e||"production"===e?"production":"development"}function i(){return"copilot/fix-80"}function n(){if("production"===a())return{url:"https://placeholder.supabase.co",anonKey:"placeholder-anon-key",serviceRoleKey:r.env.SUPABASE_SERVICE_ROLE_KEY||"placeholder-service-role-key"};{let e=r.env.SUPABASE_DEV_URL||"https://bqiapoplmkkrtnsmmxhs.supabase.co";return{url:e,anonKey:r.env.SUPABASE_DEV_ANON_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxaWFwb3BsbWtrcnRuc21teGhzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NDA3OTMsImV4cCI6MjA2ODAxNjc5M30.bZGNGvb8XYZSWkbfMYMNBAzoedp4SGOIerHmNcRqUsk",serviceRoleKey:r.env.SUPABASE_DEV_SERVICE_ROLE_KEY||"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxaWFwb3BsbWtrcnRuc21teGhzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MjQ0MDc5MywiZXhwIjoyMDY4MDE2NzkzfQ.7m9y2vqrq1Sd8bX6dl6A47WQbZoQHGKc7o2rzrcTjKI"}}}function o(e){return"https://placeholder.supabase.co"!==e.url&&"placeholder-anon-key"!==e.anonKey&&e.url.includes("supabase.co")}function u(){let e=i(),t=a(),s=n(),r=o(s);return{currentBranch:e,environment:t,supabaseUrl:s.url,hasValidConfig:r,configSource:"production"===t?"production":"development-default"}}},2099:(e,t,s)=>{s.d(t,{H:()=>o,k:()=>n});var r=s(4982),a=s(844);let i=null,n=()=>{if(i)return i;let e=(0,a.h9)();return i=(0,a.hV)(e)?(0,r.UU)(e.url,e.anonKey,{auth:{autoRefreshToken:!0,persistSession:!0,storage:window.localStorage,detectSessionInUrl:!0}}):(0,r.UU)("https://placeholder.supabase.co","placeholder-anon-key",{auth:{autoRefreshToken:!0,persistSession:!0,storage:window.localStorage,detectSessionInUrl:!0}})},o=()=>{let e=(0,a.h9)();return(0,a.hV)(e)&&e.serviceRoleKey&&"placeholder-service-role-key"!==e.serviceRoleKey?(0,r.UU)(e.url,e.serviceRoleKey,{auth:{autoRefreshToken:!1,persistSession:!1}}):(0,r.UU)("https://placeholder.supabase.co","placeholder-service-role-key",{auth:{autoRefreshToken:!1,persistSession:!1}})}},3715:(e,t,s)=>{s.d(t,{OJ:()=>c,As:()=>d,Km:()=>h});var r=s(5155),a=s(2115),i=s(2099),n=s(844);class o{getSupabase(){return this.supabase||(this.supabase=(0,i.k)()),this.supabase}getAdminClient(){return this.adminClient||(this.adminClient=(0,i.H)()),this.adminClient}async createGuestUser(){try{let e="guest_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),t="".concat(e).concat(o.GUEST_EMAIL_DOMAIN),s=this.generateSecurePassword(),{data:r,error:a}=await this.getAdminClient().auth.admin.createUser({email:t,password:s,email_confirm:!0,user_metadata:{full_name:"Guest User",is_guest:!0,created_via:"guest_mode",session_expires_at:new Date(Date.now()+o.GUEST_SESSION_DURATION).toISOString()}});if(a)throw a;if(!r.user)throw Error("Failed to create guest user");let{error:i}=await this.getAdminClient().from("users").insert({id:r.user.id,email:t,full_name:"Guest User",credit_score:100});if(i)throw i;let{data:n,error:u}=await this.getSupabase().auth.signInWithPassword({email:t,password:s});if(u)throw u;if(!n.session||!n.user)throw Error("Failed to create guest session");return{user:{id:r.user.id,email:t,full_name:"Guest User",is_guest:!0,created_at:r.user.created_at,session_expires_at:r.user.user_metadata.session_expires_at},access_token:n.session.access_token,refresh_token:n.session.refresh_token,expires_at:n.session.expires_at||0}}catch(e){throw Error("Failed to create guest user: ".concat(e instanceof Error?e.message:"Unknown error"))}}async convertGuestToPermanentUser(e,t,s,r){try{let{data:a,error:i}=await this.getAdminClient().auth.admin.updateUserById(e,{email:t,password:s,email_confirm:!1,user_metadata:{full_name:r,is_guest:!1,converted_from_guest:!0,converted_at:new Date().toISOString()}});if(i)throw i;let{data:n,error:o}=await this.getAdminClient().from("users").update({email:t,full_name:r}).eq("id",e).select().single();if(o)throw o;let{error:u}=await this.getSupabase().auth.resend({type:"signup",email:t});return u&&console.warn("Failed to send confirmation email:",u),n}catch(e){throw Error("Failed to convert guest user: ".concat(e instanceof Error?e.message:"Unknown error"))}}async isGuestUser(){try{var e;let{data:{user:t}}=await this.getSupabase().auth.getUser();return(null==t||null==(e=t.user_metadata)?void 0:e.is_guest)===!0}catch(e){return!1}}async getGuestSessionExpiration(){try{var e;let{data:{user:t}}=await this.getSupabase().auth.getUser();if(!(null==t||null==(e=t.user_metadata)?void 0:e.is_guest))return null;let s=t.user_metadata.session_expires_at;return s?new Date(s):null}catch(e){return null}}async isGuestSessionExpired(){let e=await this.getGuestSessionExpiration();return!!e&&Date.now()>e.getTime()}async cleanupExpiredGuestUsers(){let e={deleted:0,errors:[]};try{let{data:t,error:s}=await this.getAdminClient().from("users").select("id, email").like("email","%".concat(o.GUEST_EMAIL_DOMAIN)).lt("created_at",new Date(Date.now()-o.GUEST_SESSION_DURATION).toISOString());if(s)throw s;for(let s of t||[])try{let{error:t}=await this.getAdminClient().auth.admin.deleteUser(s.id);if(t)throw t;e.deleted++}catch(t){e.errors.push("Failed to delete user ".concat(s.id,": ").concat(t instanceof Error?t.message:"Unknown error"))}}catch(t){e.errors.push("Cleanup failed: ".concat(t instanceof Error?t.message:"Unknown error"))}return e}async getGuestAnalytics(){try{let e=new Date(Date.now()-o.GUEST_SESSION_DURATION),{count:t}=await this.getAdminClient().from("users").select("*",{count:"exact",head:!0}).like("email","%".concat(o.GUEST_EMAIL_DOMAIN)),{count:s}=await this.getAdminClient().from("users").select("*",{count:"exact",head:!0}).like("email","%".concat(o.GUEST_EMAIL_DOMAIN)).gte("created_at",e.toISOString()),{count:r}=await this.getAdminClient().from("users").select("*",{count:"exact",head:!0}).not("email","like","%".concat(o.GUEST_EMAIL_DOMAIN));return{totalGuestUsers:t||0,activeGuestUsers:s||0,conversionRate:100*(t?(r||0)/t:0),averageSessionDuration:o.GUEST_SESSION_DURATION/36e5}}catch(e){return console.error("Failed to get guest analytics:",e),{totalGuestUsers:0,activeGuestUsers:0,conversionRate:0,averageSessionDuration:0}}}generateSecurePassword(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*",t="";for(let s=0;s<16;s++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}constructor(){this.supabase=null,this.adminClient=null}}o.GUEST_SESSION_DURATION=864e5,o.GUEST_EMAIL_DOMAIN="@guest.coparent.online";let u=new o,l=(0,a.createContext)(void 0);function c(e){let{children:t}=e,[s,o]=(0,a.useState)({user:null,isLoading:!0,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!1}),c=(0,i.k)();(0,a.useEffect)(()=>{if(!c)return;d();let{data:{subscription:e}}=c.auth.onAuthStateChange(async(e,t)=>{"SIGNED_IN"===e&&(null==t?void 0:t.user)?await h(t.user.id):"SIGNED_OUT"===e?o({user:null,isLoading:!1,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!1}):"TOKEN_REFRESHED"===e&&(null==t||t.user)});return()=>e.unsubscribe()},[]);let d=async()=>{if(c)try{let{data:{session:e},error:t}=await c.auth.getSession();if(t){console.error("Failed to get session:",t),o(e=>({...e,isLoading:!1}));return}(null==e?void 0:e.user)?await h(e.user.id):o(e=>({...e,isLoading:!1}))}catch(e){console.error("Failed to initialize auth:",e),o(e=>({...e,isLoading:!1}))}},h=async e=>{var t,s,r,a;if(c)try{let{data:{session:a}}=await c.auth.getSession();if(!(null==a?void 0:a.user)){console.warn("No valid session found, signing out"),await w();return}let{data:i,error:n}=await c.from("users").select("*").eq("id",e).single();if(n){if(console.error("Failed to load user profile from database:",n),"42P01"===n.code||(null==(t=n.message)?void 0:t.includes("relation"))||(null==(s=n.message)?void 0:s.includes("does not exist"))){console.warn("Database tables missing, creating fallback user profile");let e={id:a.user.id,email:a.user.email||"",full_name:(null==(r=a.user.user_metadata)?void 0:r.full_name)||a.user.email||"User",credit_score:100,created_at:a.user.created_at,updated_at:new Date().toISOString()};o({user:e,isLoading:!1,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!0});return}throw n}let l=await u.isGuestUser(),d=l?await u.getGuestSessionExpiration():null;o({user:i,isLoading:!1,isGuest:l,guestSessionExpiration:d,isAuthenticated:!0}),l&&d&&Date.now()>d.getTime()&&await w()}catch(t){console.error("Failed to load user profile:",t);let{data:{session:e}}=await c.auth.getSession().catch(()=>({data:{session:null}}));(null==e?void 0:e.user)?(console.warn("Database error but session valid, using fallback user"),o({user:{id:e.user.id,email:e.user.email||"",full_name:(null==(a=e.user.user_metadata)?void 0:a.full_name)||e.user.email||"User",credit_score:100,created_at:e.user.created_at,updated_at:new Date().toISOString()},isLoading:!1,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!0})):o({user:null,isLoading:!1,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!1})}},g=async(e,t)=>{if(!c)throw Error("Supabase client not available");try{o(e=>({...e,isLoading:!0}));let s=(0,n.h9)();console.log("Attempting sign in with config:",{url:s.url,hasAnonKey:!!s.anonKey,configSource:(0,n.GY)()});let{data:r,error:a}=await c.auth.signInWithPassword({email:e,password:t});if(a)throw a;if(!r.user)throw Error("No user returned from sign in");await h(r.user.id)}catch(e){throw o(e=>({...e,isLoading:!1})),e}},m=async(e,t,s)=>{if(!c)throw Error("Supabase client not available");try{o(e=>({...e,isLoading:!0}));let{data:r,error:a}=await c.auth.signUp({email:e,password:t,options:{data:{full_name:s}}});if(a)throw a;if(!r.user)throw Error("No user returned from sign up");let{error:i}=await c.from("users").insert({id:r.user.id,email:e,full_name:s,credit_score:100});if(i)throw i;await h(r.user.id)}catch(e){throw o(e=>({...e,isLoading:!1})),e}},w=async()=>{if(c)try{await c.auth.signOut(),o({user:null,isLoading:!1,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!1})}catch(e){console.error("Failed to sign out:",e)}},f=async()=>{try{o(e=>({...e,isLoading:!0})),await u.createGuestUser()}catch(e){throw o(e=>({...e,isLoading:!1})),e}},S=async(e,t,r)=>{try{if(!s.user||!s.isGuest)throw Error("No guest user to convert");o(e=>({...e,isLoading:!0}));let a=await u.convertGuestToPermanentUser(s.user.id,e,t,r);o(e=>({...e,user:a,isGuest:!1,guestSessionExpiration:null,isLoading:!1}))}catch(e){throw o(e=>({...e,isLoading:!1})),e}},_=async()=>{if(c)try{var e;let{data:t,error:s}=await c.auth.refreshSession();if(s)throw s;(null==(e=t.session)?void 0:e.user)&&await h(t.session.user.id)}catch(e){console.error("Failed to refresh session:",e),await w()}},p={...s,signIn:g,signUp:m,signOut:w,startGuestSession:f,convertGuestToUser:S,refreshSession:_};return(0,r.jsx)(l.Provider,{value:p,children:t})}function d(){let e=(0,a.useContext)(l);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function h(){let{isGuest:e,guestSessionExpiration:t}=d(),s=(t?t.getTime()-Date.now():0)/36e5;return{isGuest:e,hoursUntilExpiration:s,shouldShowConversionPrompt:e&&s<4&&s>0,shouldShowUrgentPrompt:e&&s<1&&s>0,guestSessionExpiration:t}}}}]);