(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[259],{469:(e,r,t)=>{"use strict";t.d(r,{m:()=>o});var s=t(5155),a=t(2115),i=t(4110),n=t(2099);let d=["7:00","8:00","9:00","12:00","15:00","16:00","17:00","18:00","19:00","20:00"],l=["8:00","9:00","10:00","11:00","12:00","14:00","16:00","17:00","18:00","19:00","20:00"],c={"7:00":"Early morning","8:00":"Before school/work","9:00":"Morning","12:00":"Lunch time","15:00":"After school","16:00":"Late afternoon","17:00":"Before dinner","18:00":"Dinner time","19:00":"After dinner","20:00":"Evening","21:00":"Late evening"};function o(e){let{relationshipId:r,currentUserId:t,dayType:o,existingPreferences:f=[],timeSlots:m,onPreferencesUpdated:h}=e,[p,u]=(0,a.useState)(!1),[x,y]=(0,a.useState)(null),[g,b]=(0,a.useState)(!1),[j,N]=(0,a.useState)([]),w=(0,n.k)(),v=m||("weekday"===o?d:l);(0,a.useEffect)(()=>{N(f.filter(e=>e.dayType===o).map(e=>e.time))},[f,o]);let _=e=>{let[r,t]=e.split(":"),s=parseInt(r);return"".concat(0===s?12:s>12?s-12:s,":").concat(t," ").concat(s>=12?"PM":"AM")},P=e=>c[e]||"",S=(e,r)=>{r?N(r=>[...r,e]):N(r=>r.filter(r=>r!==e))},k=async e=>{u(!0),y(null);try{let s=e.map((e,s)=>({relationshipId:r,userId:t,time:e.id,dayType:o,priority:s+1,context:P(e.id)}));await w.from("handoff_time_preferences").delete().eq("relationshipId",r).eq("userId",t).eq("dayType",o);let{error:a}=await w.from("handoff_time_preferences").insert(s);if(a)throw a;if(h){let e=s.map((e,r)=>({...e,id:"temp-".concat(r),createdAt:new Date,updatedAt:new Date}));h(e)}b(!1)}catch(e){y("Error saving handoff time preferences. Please try again."),console.error("Error saving handoff time preferences:",e)}finally{u(!1)}};if(g){let e=(()=>{let e=f.filter(e=>e.dayType===o).reduce((e,r)=>(e[r.time]=r,e),{});return j.sort((r,t)=>{let s=e[r],a=e[t];return s&&a?s.priority-a.priority:s?-1:a?1:r.localeCompare(t)}).map(e=>({id:e,label:_(e),description:P(e),metadata:{time:e,dayType:o}}))})();return(0,s.jsxs)("div",{className:"space-y-4",children:[p&&(0,s.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-4",children:(0,s.jsx)("p",{className:"text-blue-800",children:"Saving your preferences..."})}),x&&(0,s.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:(0,s.jsx)("p",{className:"text-red-800",children:x})}),(0,s.jsx)("button",{onClick:()=>{b(!1),y(null)},className:"mb-4 text-blue-600 hover:text-blue-800 flex items-center",disabled:p,children:"← Back to Time Selection"}),(0,s.jsx)(i.S,{items:e,onSortComplete:k,title:"Sort Your ".concat("weekday"===o?"Weekday":"Weekend"," Handoff Time Preferences"),description:"Choose which handoff time you prefer when given the option. Your most preferred time will be ranked first."})]})}return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsxs)("h1",{className:"text-2xl font-bold mb-2",children:["weekday"===o?"Weekday":"Weekend"," Handoff Time Preferences"]}),(0,s.jsx)("p",{className:"text-gray-600",children:"Select your preferred handoff times and sort them by preference to help with custody scheduling."})]}),x&&(0,s.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-md p-4",children:(0,s.jsx)("p",{className:"text-red-800",children:x})}),(0,s.jsxs)("div",{"data-testid":"time-selector",className:"space-y-4",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold",children:"Select Preferred Handoff Times"}),(0,s.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3",children:v.map(e=>(0,s.jsxs)("label",{className:"\n                flex items-center space-x-2 p-3 rounded-lg border cursor-pointer transition-colors\n                ".concat(j.includes(e)?"bg-blue-50 border-blue-300 text-blue-900":"bg-white border-gray-200 hover:bg-gray-50","\n              "),children:[(0,s.jsx)("input",{type:"checkbox",checked:j.includes(e),onChange:r=>S(e,r.target.checked),className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500","data-testid":"time-".concat(e)}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("div",{className:"font-medium",children:_(e)}),(0,s.jsx)("div",{className:"text-sm text-gray-500",children:P(e)})]})]},e))}),(0,s.jsxs)("div",{"data-testid":"selected-times",className:"mt-4",children:[(0,s.jsxs)("h3",{className:"text-md font-medium mb-2",children:["Selected Times (",j.length,")"]}),j.length>0?(0,s.jsx)("div",{className:"flex flex-wrap gap-2",children:j.map(e=>(0,s.jsxs)("span",{"data-testid":"selected-".concat(e),className:"inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800",children:[_(e),(0,s.jsx)("button",{onClick:()=>S(e,!1),className:"ml-2 text-blue-600 hover:text-blue-800","aria-label":"Remove ".concat(_(e)),children:"\xd7"})]},e))}):(0,s.jsx)("p",{className:"text-gray-500 text-sm",children:"No times selected"})]}),(0,s.jsx)("button",{onClick:()=>{if(j.length<2)return void y("Please select at least 2 handoff times to sort.");b(!0),y(null)},disabled:j.length<2||p,"data-testid":"start-sorting",className:"\n            w-full py-3 px-4 rounded-md font-medium transition-colors\n            ".concat(j.length>=2&&!p?"bg-blue-600 text-white hover:bg-blue-700":"bg-gray-300 text-gray-500 cursor-not-allowed","\n          "),children:p?"Saving...":"Start Sorting Preferences"}),j.length<2&&(0,s.jsx)("p",{className:"text-sm text-gray-500 text-center",children:"Select at least 2 handoff times to enable sorting"})]})]})}},2790:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>f});var s=t(5155),a=t(2115),i=t(5034),n=t(387),d=t(469),l=t(2099);class c{async getUserPreferences(e,r){try{let{data:t,error:s}=await this.supabase.from("day_preferences").select("*").eq("parent_id",e).eq("relationship_id",r).order("priority",{ascending:!0});if(s)throw s;let{data:a,error:i}=await this.supabase.from("date_preferences").select("*").eq("parent_id",e).eq("relationship_id",r).order("priority",{ascending:!0});if(i)throw i;let{data:n,error:d}=await this.supabase.from("handoff_times").select("*").eq("relationship_id",r).order("time",{ascending:!0});if(d)throw d;return{dayPreferences:t||[],datePreferences:a||[],handoffTimes:n||[]}}catch(e){throw console.error("Error fetching user preferences:",e),Error("Failed to fetch user preferences")}}async saveDayPreferences(e,r,t){try{let{error:s}=await this.supabase.from("day_preferences").delete().eq("parent_id",e).eq("relationship_id",r);if(s)throw s;let a=t.map(t=>({relationship_id:r,parent_id:e,day_of_week:t.dayOfWeek,priority:t.priority})),{data:i,error:n}=await this.supabase.from("day_preferences").insert(a).select();if(n)throw n;return i||[]}catch(e){throw console.error("Error saving day preferences:",e),Error("Failed to save day preferences")}}async saveDatePreferences(e,r,t){try{let{error:s}=await this.supabase.from("date_preferences").delete().eq("parent_id",e).eq("relationship_id",r);if(s)throw s;let a=t.map(t=>({relationship_id:r,parent_id:e,date:t.date,priority:t.priority})),{data:i,error:n}=await this.supabase.from("date_preferences").insert(a).select();if(n)throw n;return i||[]}catch(e){throw console.error("Error saving date preferences:",e),Error("Failed to save date preferences")}}async saveHandoffTimePreferences(e,r){try{let{error:t}=await this.supabase.from("handoff_times").delete().eq("relationship_id",e);if(t)throw t;let s=r.map(r=>({relationship_id:e,time:r.time,priority_parent_a:r.priorityParentA,priority_parent_b:r.priorityParentB})),{data:a,error:i}=await this.supabase.from("handoff_times").insert(s).select();if(i)throw i;return a||[]}catch(e){throw console.error("Error saving handoff time preferences:",e),Error("Failed to save handoff time preferences")}}async getRelationshipPreferenceSummary(e){try{let{data:r,error:t}=await this.supabase.from("co_parent_relationships").select("parent_a_id, parent_b_id").eq("id",e).single();if(t)throw t;let s=await this.getUserPreferenceSummary(r.parent_a_id,e),a=await this.getUserPreferenceSummary(r.parent_b_id,e);return{parentA:s,parentB:a}}catch(e){return console.error("Error fetching relationship preference summary:",e),{parentA:null,parentB:null}}}async getUserPreferenceSummary(e,r){try{let t=await this.getUserPreferences(e,r),s=t.dayPreferences.sort((e,r)=>e.priority-r.priority).map(e=>e.day_of_week),a=t.handoffTimes.map(t=>({time:t.time,priority:e===r?t.priority_parent_a:t.priority_parent_b})).sort((e,r)=>e.priority-r.priority).map(e=>e.time),i=t.datePreferences.sort((e,r)=>e.priority-r.priority).map(e=>e.date),n=[...t.dayPreferences.map(e=>e.updated_at),...t.datePreferences.map(e=>e.updated_at),...t.handoffTimes.map(e=>e.updated_at)],d=n.length>0?n.sort().reverse()[0]:new Date().toISOString();return{userId:e,relationshipId:r,preferredDays:s,preferredTimes:a,importantDates:i,lastUpdated:d}}catch(e){return console.error("Error getting user preference summary:",e),null}}async hasPreferences(e,r){try{let t=await this.getUserPreferences(e,r);return t.dayPreferences.length>0||t.datePreferences.length>0||t.handoffTimes.length>0}catch(e){return console.error("Error checking if preferences exist:",e),!1}}async getPreferenceConflicts(e){try{let r=await this.getRelationshipPreferenceSummary(e);if(!r.parentA||!r.parentB)return{dayConflicts:[],timeConflicts:[],dateConflicts:[]};let t=[];for(let e=0;e<=6;e++){let s=r.parentA.preferredDays.indexOf(e),a=r.parentB.preferredDays.indexOf(e);-1!==s&&-1!==a&&s<3&&a<3&&t.push({day:e,parentAPrefs:s+1,parentBPrefs:a+1})}let s=[];for(let e of r.parentA.preferredTimes.filter(e=>r.parentB.preferredTimes.includes(e))){let t=r.parentA.preferredTimes.indexOf(e),a=r.parentB.preferredTimes.indexOf(e);s.push({time:e,parentAPrefs:t+1,parentBPrefs:a+1})}let a=[];for(let e of r.parentA.importantDates.filter(e=>r.parentB.importantDates.includes(e)))a.push({date:e,bothWant:!0});return{dayConflicts:t,timeConflicts:s,dateConflicts:a}}catch(e){return console.error("Error analyzing preference conflicts:",e),{dayConflicts:[],timeConflicts:[],dateConflicts:[]}}}constructor(e=!1){e?this.supabase=null:this.supabase=(0,l.k)()}}let o=new c;function f(){var e;let{user:r,currentRelationship:t,loading:c,error:f}=function(){let[e,r]=(0,a.useState)(null),[t,s]=(0,a.useState)([]),[i,n]=(0,a.useState)(null),[d,c]=(0,a.useState)(!0),[o,f]=(0,a.useState)(null),m=(0,l.k)();(0,a.useEffect)(()=>{h()},[]);let h=async()=>{try{c(!0),f(null);let{data:{user:e},error:t}=await m.auth.getUser();if(t)throw t;if(!e){r(null),s([]),n(null);return}let{data:a,error:d}=await m.from("users").select("*").eq("id",e.id).single();if(d)throw d;r(a);let{data:l,error:o}=await m.from("co_parent_relationships").select("\n          *,\n          child:children(*)\n        ").or("parent_a_id.eq.".concat(e.id,",parent_b_id.eq.").concat(e.id));if(o)throw o;s(l||[]),l&&l.length>0&&!i&&n(l[0])}catch(e){console.error("Error fetching user data:",e),f(e.message||"Failed to fetch user data")}finally{c(!1)}};return{user:e,relationships:t,currentRelationship:i,loading:d,error:o,setCurrentRelationshipId:e=>{let r=t.find(r=>r.id===e);r&&n(r)}}}(),[m,h]=(0,a.useState)(null),[p,u]=(0,a.useState)(null),[x,y]=(0,a.useState)(!0),[g,b]=(0,a.useState)(null);(0,a.useEffect)(()=>{r&&t&&j()},[r,t]);let j=async()=>{if(r&&t)try{y(!0),b(null);let e=await o.getUserPreferences(r.id,t.id);h(e);let s=t.parent_a_id===r.id?t.parent_b_id:t.parent_a_id,a=await o.getUserPreferences(s,t.id);u(a)}catch(e){console.error("Error loading preferences:",e),b(e.message||"Failed to load preferences")}finally{y(!1)}},N=()=>{j()};return c||x?(0,s.jsx)("div",{className:"container mx-auto px-4 py-8",children:(0,s.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,s.jsxs)("div",{className:"animate-pulse",children:[(0,s.jsx)("div",{className:"h-8 bg-gray-200 rounded w-1/3 mb-4"}),(0,s.jsx)("div",{className:"h-4 bg-gray-200 rounded w-2/3 mb-8"}),(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsx)("div",{className:"h-32 bg-gray-200 rounded"}),(0,s.jsx)("div",{className:"h-32 bg-gray-200 rounded"})]})]})})}):f||g?(0,s.jsx)("div",{className:"container mx-auto px-4 py-8",children:(0,s.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,s.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:[(0,s.jsx)("h2",{className:"text-red-800 font-semibold mb-2",children:"Error Loading Preferences"}),(0,s.jsx)("p",{className:"text-red-600",children:f||g}),(0,s.jsx)("button",{onClick:j,className:"mt-4 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700",children:"Try Again"})]})})}):r&&t?(0,s.jsx)("div",{className:"container mx-auto px-4 py-8",children:(0,s.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,s.jsxs)("div",{className:"mb-8",children:[(0,s.jsx)("h1",{className:"text-3xl font-bold mb-2",children:"Preferences"}),(0,s.jsx)("p",{className:"text-gray-600",children:"Set your preferences for scheduling and co-parenting arrangements. These preferences will be saved and applied when creating or suggesting schedules."}),t&&(0,s.jsxs)("div",{className:"mt-2 text-sm text-gray-500",children:["Current relationship: Child - ",(null==(e=t.child)?void 0:e.name)||"Unknown"]})]}),(0,s.jsxs)("div",{className:"space-y-8",children:[(0,s.jsxs)("section",{children:[(0,s.jsx)("h2",{className:"text-2xl font-semibold mb-4",children:"Day Preferences"}),(0,s.jsx)("p",{className:"text-gray-600 mb-4",children:"Rank the days of the week by your preference to have your child. Most preferred days will be prioritized in scheduling suggestions."}),(0,s.jsx)(i.DayPreferenceSorting,{relationshipId:t.id,currentUserId:r.id,existingPreferences:(null==m?void 0:m.dayPreferences)||[],otherParentPreferences:(null==p?void 0:p.dayPreferences)||[],onPreferencesUpdated:N})]}),(0,s.jsxs)("section",{"data-testid":"date-preferences",children:[(0,s.jsx)("h2",{className:"text-2xl font-semibold mb-4",children:"Date Preferences"}),(0,s.jsx)("p",{className:"text-gray-600 mb-4",children:"Select and rank specific dates that are important to you (holidays, birthdays, special events)."}),(0,s.jsx)(n.Q,{relationshipId:t.id,currentUserId:r.id,selectedDates:[],existingPreferences:(null==m?void 0:m.datePreferences)||[],onPreferencesUpdated:N})]}),(0,s.jsxs)("section",{"data-testid":"handoff-time-preferences",children:[(0,s.jsx)("h2",{className:"text-2xl font-semibold mb-4",children:"Handoff Time Preferences"}),(0,s.jsx)("p",{className:"text-gray-600 mb-4",children:"Set your preferred times for child handoffs. Different times can be set for weekdays and weekends."}),(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-medium mb-3",children:"Weekday Handoff Times"}),(0,s.jsx)(d.m,{relationshipId:t.id,currentUserId:r.id,dayType:"weekday",existingPreferences:[],onPreferencesUpdated:N})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-medium mb-3",children:"Weekend Handoff Times"}),(0,s.jsx)(d.m,{relationshipId:t.id,currentUserId:r.id,dayType:"weekend",existingPreferences:[],onPreferencesUpdated:N})]})]})]}),m&&(0,s.jsxs)("section",{className:"bg-blue-50 border border-blue-200 rounded-lg p-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold mb-4 text-blue-800",children:"Your Preference Summary"}),(0,s.jsxs)("div",{className:"grid md:grid-cols-3 gap-4 text-sm",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-medium text-blue-700 mb-2",children:"Day Preferences"}),m.dayPreferences.length>0?(0,s.jsx)("ul",{className:"space-y-1",children:m.dayPreferences.sort((e,r)=>e.priority-r.priority).slice(0,3).map((e,r)=>(0,s.jsxs)("li",{className:"text-blue-600",children:[r+1,". ",["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e.day_of_week]]},e.id))}):(0,s.jsx)("p",{className:"text-gray-500 italic",children:"No preferences set"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-medium text-blue-700 mb-2",children:"Date Preferences"}),m.datePreferences.length>0?(0,s.jsx)("ul",{className:"space-y-1",children:m.datePreferences.sort((e,r)=>e.priority-r.priority).slice(0,3).map((e,r)=>(0,s.jsxs)("li",{className:"text-blue-600",children:[r+1,". ",new Date(e.date).toLocaleDateString()]},e.id))}):(0,s.jsx)("p",{className:"text-gray-500 italic",children:"No preferences set"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-medium text-blue-700 mb-2",children:"Handoff Times"}),m.handoffTimes.length>0?(0,s.jsx)("ul",{className:"space-y-1",children:m.handoffTimes.slice(0,3).map((e,r)=>(0,s.jsx)("li",{className:"text-blue-600",children:e.time},e.id))}):(0,s.jsx)("p",{className:"text-gray-500 italic",children:"No preferences set"})]})]})]})]})]})}):(0,s.jsx)("div",{className:"container mx-auto px-4 py-8",children:(0,s.jsx)("div",{className:"max-w-4xl mx-auto",children:(0,s.jsxs)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-6",children:[(0,s.jsx)("h2",{className:"text-yellow-800 font-semibold mb-2",children:"Authentication Required"}),(0,s.jsx)("p",{className:"text-yellow-600",children:"Please log in and ensure you have a co-parent relationship set up to manage preferences."})]})})})}},3538:(e,r,t)=>{Promise.resolve().then(t.bind(t,2790))},5034:(e,r,t)=>{"use strict";t.d(r,{DayPreferenceSorting:()=>l});var s=t(5155),a=t(2115),i=t(4110),n=t(2099);let d=[{id:"0",label:"Sunday",description:"Weekend day"},{id:"1",label:"Monday",description:"Start of school week"},{id:"2",label:"Tuesday",description:"School day"},{id:"3",label:"Wednesday",description:"Mid-week"},{id:"4",label:"Thursday",description:"School day"},{id:"5",label:"Friday",description:"End of school week"},{id:"6",label:"Saturday",description:"Weekend day"}];function l(e){let{relationshipId:r,currentUserId:t,existingPreferences:l=[],otherParentPreferences:c=[],onPreferencesUpdated:o}=e,[f,m]=(0,a.useState)(d),[h,p]=(0,a.useState)(!1),[u,x]=(0,a.useState)(null),[y,g]=(0,a.useState)(!1);(0,a.useEffect)(()=>{if(l.length>0){let e=[...l].sort((e,r)=>e.priority-r.priority),r=e.map(e=>d.find(r=>parseInt(r.id)===e.dayOfWeek)),t=new Set(e.map(e=>e.dayOfWeek.toString()));m([...r,...d.filter(e=>!t.has(e.id))])}},[l]);let b=async e=>{p(!0),x(null);try{let s=(0,n.k)(),a=e.map((e,s)=>({relationship_id:r,parent_id:t,day_of_week:parseInt(e.id),priority:s+1})),{error:i}=await s.from("day_preferences").upsert(a,{onConflict:"relationship_id,parent_id,day_of_week"});if(i)throw i;m(e),o&&o()}catch(e){x("Error saving preferences. Please try again."),console.error("Error saving day preferences:",e)}finally{p(!1)}};return(0,s.jsxs)("div",{className:"space-y-6","data-testid":"day-preferences",children:[c.length>0&&(0,s.jsxs)("div",{className:"bg-gray-50 p-4 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,s.jsx)("h3",{className:"text-lg font-medium",children:"Other Parent's Preferences"}),(0,s.jsx)("button",{onClick:()=>g(!y),className:"text-blue-600 hover:text-blue-800 text-sm",children:y?"Hide":"Show"})]}),y&&(0,s.jsx)("div",{className:"space-y-2",children:c.sort((e,r)=>e.priority-r.priority).map((e,r)=>{let t=d.find(r=>parseInt(r.id)===e.dayOfWeek);return(0,s.jsxs)("div",{className:"flex items-center text-sm",children:[(0,s.jsx)("span",{className:"w-6 h-6 bg-gray-300 rounded-full flex items-center justify-center text-xs mr-3",children:r+1}),(0,s.jsx)("span",{children:null==t?void 0:t.label})]},e.dayOfWeek)})})]}),u&&(0,s.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:(0,s.jsx)("p",{className:"text-red-800",children:u})}),h&&(0,s.jsx)("div",{className:"text-center py-4",children:(0,s.jsx)("p",{className:"text-gray-600",children:"Saving your preferences..."})}),(0,s.jsx)("div",{className:"text-center",children:(0,s.jsx)("button",{"data-testid":"sort-day-preferences",className:"bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors",onClick:()=>{let e=document.querySelector('[data-testid="sorting-component"]');e&&e.scrollIntoView({behavior:"smooth"})},children:"Start Sorting Day Preferences"})}),(0,s.jsx)(i.S,{items:f,onSortComplete:b,title:"Sort Your Day Preferences",description:"Rank the days of the week by your preference to have your child. Most preferred days will be ranked higher."})]})}}},e=>{var r=r=>e(e.s=r);e.O(0,[277,982,804,796,110,387,441,684,358],()=>r(3538)),_N_E=e.O()}]);