"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[715],{2047:(e,t,r)=>{r.d(t,{k:()=>o,H:()=>u});var s=r(4982),a=r(9509);function i(){let e=function(){if(void 0!==a&&a.env){if(a.env.GITHUB_HEAD_REF)return a.env.GITHUB_HEAD_REF;if(a.env.GITHUB_REF)return a.env.GITHUB_REF.replace("refs/heads/","");if(a.env.VERCEL_GIT_COMMIT_REF)return a.env.VERCEL_GIT_COMMIT_REF;if(a.env.BRANCH)return a.env.BRANCH}return"main"}();if("main"===e||"master"===e||"production"===e)return{url:"https://gjgldkinpnckfwzwdbmt.supabase.co",anonKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqZ2xka2lucG5ja2Z3endkYm10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0OTczMDYsImV4cCI6MjA2NzA3MzMwNn0.5ZQourcUdjk19MWjLQ9O0VhcHJj09YPzcxbN35MfMtQ",serviceRoleKey:a.env.SUPABASE_SERVICE_ROLE_KEY||"placeholder-service-role-key"};let t=e.replace(/[^a-zA-Z0-9]/g,"_").toUpperCase(),r=a.env["NEXT_PUBLIC_SUPABASE_URL_".concat(t)]||a.env["SUPABASE_URL_".concat(t)],s=a.env["NEXT_PUBLIC_SUPABASE_ANON_KEY_".concat(t)]||a.env["SUPABASE_ANON_KEY_".concat(t)],i=a.env["SUPABASE_SERVICE_ROLE_KEY_".concat(t)];if(r&&s)return{url:r,anonKey:s,serviceRoleKey:i||"placeholder-service-role-key"};let n=a.env.NEXT_PUBLIC_SUPABASE_PREVIEW_URL||a.env.SUPABASE_PREVIEW_URL,o=a.env.NEXT_PUBLIC_SUPABASE_PREVIEW_ANON_KEY||a.env.SUPABASE_PREVIEW_ANON_KEY,u=a.env.SUPABASE_PREVIEW_SERVICE_ROLE_KEY;return n&&o?{url:n,anonKey:o,serviceRoleKey:u||"placeholder-service-role-key"}:{url:"https://gjgldkinpnckfwzwdbmt.supabase.co",anonKey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqZ2xka2lucG5ja2Z3endkYm10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0OTczMDYsImV4cCI6MjA2NzA3MzMwNn0.5ZQourcUdjk19MWjLQ9O0VhcHJj09YPzcxbN35MfMtQ",serviceRoleKey:a.env.SUPABASE_SERVICE_ROLE_KEY||"placeholder-service-role-key"}}function n(e){return"https://placeholder.supabase.co"!==e.url&&"placeholder-anon-key"!==e.anonKey&&e.url.includes("supabase.co")}let o=()=>{let e=i();return n(e)?(0,s.UU)(e.url,e.anonKey):(0,s.UU)("https://placeholder.supabase.co","placeholder-anon-key")},u=()=>{let e=i();return n(e)&&e.serviceRoleKey&&"placeholder-service-role-key"!==e.serviceRoleKey?(0,s.UU)(e.url,e.serviceRoleKey,{auth:{autoRefreshToken:!1,persistSession:!1}}):(0,s.UU)("https://placeholder.supabase.co","placeholder-service-role-key",{auth:{autoRefreshToken:!1,persistSession:!1}})}},3715:(e,t,r)=>{r.d(t,{OJ:()=>l,As:()=>c,Km:()=>d});var s=r(5155),a=r(2115),i=r(2047);class n{getSupabase(){return this.supabase||(this.supabase=(0,i.k)()),this.supabase}getAdminClient(){return this.adminClient||(this.adminClient=(0,i.H)()),this.adminClient}async createGuestUser(){try{let e="guest_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),t="".concat(e).concat(n.GUEST_EMAIL_DOMAIN),r=this.generateSecurePassword(),{data:s,error:a}=await this.getAdminClient().auth.admin.createUser({email:t,password:r,email_confirm:!0,user_metadata:{full_name:"Guest User",is_guest:!0,created_via:"guest_mode",session_expires_at:new Date(Date.now()+n.GUEST_SESSION_DURATION).toISOString()}});if(a)throw a;if(!s.user)throw Error("Failed to create guest user");let{error:i}=await this.getAdminClient().from("users").insert({id:s.user.id,email:t,full_name:"Guest User",credit_score:100});if(i)throw i;let{data:o,error:u}=await this.getSupabase().auth.signInWithPassword({email:t,password:r});if(u)throw u;if(!o.session||!o.user)throw Error("Failed to create guest session");return{user:{id:s.user.id,email:t,full_name:"Guest User",is_guest:!0,created_at:s.user.created_at,session_expires_at:s.user.user_metadata.session_expires_at},access_token:o.session.access_token,refresh_token:o.session.refresh_token,expires_at:o.session.expires_at||0}}catch(e){throw Error("Failed to create guest user: ".concat(e instanceof Error?e.message:"Unknown error"))}}async convertGuestToPermanentUser(e,t,r,s){try{let{data:a,error:i}=await this.getAdminClient().auth.admin.updateUserById(e,{email:t,password:r,email_confirm:!1,user_metadata:{full_name:s,is_guest:!1,converted_from_guest:!0,converted_at:new Date().toISOString()}});if(i)throw i;let{data:n,error:o}=await this.getAdminClient().from("users").update({email:t,full_name:s}).eq("id",e).select().single();if(o)throw o;let{error:u}=await this.getSupabase().auth.resend({type:"signup",email:t});return u&&console.warn("Failed to send confirmation email:",u),n}catch(e){throw Error("Failed to convert guest user: ".concat(e instanceof Error?e.message:"Unknown error"))}}async isGuestUser(){try{var e;let{data:{user:t}}=await this.getSupabase().auth.getUser();return(null==t||null==(e=t.user_metadata)?void 0:e.is_guest)===!0}catch(e){return!1}}async getGuestSessionExpiration(){try{var e;let{data:{user:t}}=await this.getSupabase().auth.getUser();if(!(null==t||null==(e=t.user_metadata)?void 0:e.is_guest))return null;let r=t.user_metadata.session_expires_at;return r?new Date(r):null}catch(e){return null}}async isGuestSessionExpired(){let e=await this.getGuestSessionExpiration();return!!e&&Date.now()>e.getTime()}async cleanupExpiredGuestUsers(){let e={deleted:0,errors:[]};try{let{data:t,error:r}=await this.getAdminClient().from("users").select("id, email").like("email","%".concat(n.GUEST_EMAIL_DOMAIN)).lt("created_at",new Date(Date.now()-n.GUEST_SESSION_DURATION).toISOString());if(r)throw r;for(let r of t||[])try{let{error:t}=await this.getAdminClient().auth.admin.deleteUser(r.id);if(t)throw t;e.deleted++}catch(t){e.errors.push("Failed to delete user ".concat(r.id,": ").concat(t instanceof Error?t.message:"Unknown error"))}}catch(t){e.errors.push("Cleanup failed: ".concat(t instanceof Error?t.message:"Unknown error"))}return e}async getGuestAnalytics(){try{let e=new Date(Date.now()-n.GUEST_SESSION_DURATION),{count:t}=await this.getAdminClient().from("users").select("*",{count:"exact",head:!0}).like("email","%".concat(n.GUEST_EMAIL_DOMAIN)),{count:r}=await this.getAdminClient().from("users").select("*",{count:"exact",head:!0}).like("email","%".concat(n.GUEST_EMAIL_DOMAIN)).gte("created_at",e.toISOString()),{count:s}=await this.getAdminClient().from("users").select("*",{count:"exact",head:!0}).not("email","like","%".concat(n.GUEST_EMAIL_DOMAIN));return{totalGuestUsers:t||0,activeGuestUsers:r||0,conversionRate:100*(t?(s||0)/t:0),averageSessionDuration:n.GUEST_SESSION_DURATION/36e5}}catch(e){return console.error("Failed to get guest analytics:",e),{totalGuestUsers:0,activeGuestUsers:0,conversionRate:0,averageSessionDuration:0}}}generateSecurePassword(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*",t="";for(let r=0;r<16;r++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}constructor(){this.supabase=null,this.adminClient=null}}n.GUEST_SESSION_DURATION=864e5,n.GUEST_EMAIL_DOMAIN="@guest.coparent.online";let o=new n,u=(0,a.createContext)(void 0);function l(e){let{children:t}=e,[r,n]=(0,a.useState)({user:null,isLoading:!0,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!1}),l=(0,i.k)();(0,a.useEffect)(()=>{if(!l)return;c();let{data:{subscription:e}}=l.auth.onAuthStateChange(async(e,t)=>{"SIGNED_IN"===e&&(null==t?void 0:t.user)?await d(t.user.id):"SIGNED_OUT"===e&&n({user:null,isLoading:!1,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!1})});return()=>e.unsubscribe()},[]);let c=async()=>{if(l)try{let{data:{session:e}}=await l.auth.getSession();(null==e?void 0:e.user)?await d(e.user.id):n(e=>({...e,isLoading:!1}))}catch(e){console.error("Failed to initialize auth:",e),n(e=>({...e,isLoading:!1}))}},d=async e=>{if(l)try{let{data:t,error:r}=await l.from("users").select("*").eq("id",e).single();if(r)throw r;let s=await o.isGuestUser(),a=s?await o.getGuestSessionExpiration():null;n({user:t,isLoading:!1,isGuest:s,guestSessionExpiration:a,isAuthenticated:!0}),s&&a&&Date.now()>a.getTime()&&await E()}catch(e){console.error("Failed to load user profile:",e),n({user:null,isLoading:!1,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!1})}},h=async(e,t)=>{if(!l)throw Error("Supabase client not available");try{n(e=>({...e,isLoading:!0}));let{data:r,error:s}=await l.auth.signInWithPassword({email:e,password:t});if(s)throw s;if(!r.user)throw Error("No user returned from sign in");await d(r.user.id)}catch(e){throw n(e=>({...e,isLoading:!1})),e}},_=async(e,t,r)=>{if(!l)throw Error("Supabase client not available");try{n(e=>({...e,isLoading:!0}));let{data:s,error:a}=await l.auth.signUp({email:e,password:t,options:{data:{full_name:r}}});if(a)throw a;if(!s.user)throw Error("No user returned from sign up");let{error:i}=await l.from("users").insert({id:s.user.id,email:e,full_name:r,credit_score:100});if(i)throw i;await d(s.user.id)}catch(e){throw n(e=>({...e,isLoading:!1})),e}},E=async()=>{if(l)try{await l.auth.signOut(),n({user:null,isLoading:!1,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!1})}catch(e){console.error("Failed to sign out:",e)}},S=async()=>{try{n(e=>({...e,isLoading:!0})),await o.createGuestUser()}catch(e){throw n(e=>({...e,isLoading:!1})),e}},w=async(e,t,s)=>{try{if(!r.user||!r.isGuest)throw Error("No guest user to convert");n(e=>({...e,isLoading:!0}));let a=await o.convertGuestToPermanentUser(r.user.id,e,t,s);n(e=>({...e,user:a,isGuest:!1,guestSessionExpiration:null,isLoading:!1}))}catch(e){throw n(e=>({...e,isLoading:!1})),e}},g=async()=>{if(l)try{var e;let{data:t,error:r}=await l.auth.refreshSession();if(r)throw r;(null==(e=t.session)?void 0:e.user)&&await d(t.session.user.id)}catch(e){console.error("Failed to refresh session:",e),await E()}},m={...r,signIn:h,signUp:_,signOut:E,startGuestSession:S,convertGuestToUser:w,refreshSession:g};return(0,s.jsx)(u.Provider,{value:m,children:t})}function c(){let e=(0,a.useContext)(u);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}function d(){let{isGuest:e,guestSessionExpiration:t}=c(),r=(t?t.getTime()-Date.now():0)/36e5;return{isGuest:e,hoursUntilExpiration:r,shouldShowConversionPrompt:e&&r<4&&r>0,shouldShowUrgentPrompt:e&&r<1&&r>0,guestSessionExpiration:t}}}}]);