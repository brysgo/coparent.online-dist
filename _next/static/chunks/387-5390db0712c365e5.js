"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[387],{387:(e,t,r)=>{r.d(t,{Q:()=>d});var a=r(5155),s=r(2115),i=r(4110),n=r(285),l=r(6695);function o(e){let{selectedDates:t,onDatesChange:r,onStartSorting:i,holidayData:o={}}=e,[c,d]=(0,s.useState)(""),p=e=>{let a=new Date;if(a.setHours(0,0,0,0),e<a)return;let s=e.toISOString().split("T")[0];t.map(e=>e.toISOString().split("T")[0]).includes(s)||r([...t,e])},m=e=>{r(t.filter(t=>t.toISOString()!==e.toISOString()))},h=e=>{let t=o[e.toISOString().split("T")[0]];return t?"".concat(t," (").concat(e.toLocaleDateString(),")"):e.toLocaleDateString()},f=[{date:new Date("2024-12-25"),label:"Christmas Day"},{date:new Date("2024-01-01"),label:"New Year's Day"},{date:new Date("2024-07-04"),label:"Independence Day"},{date:new Date("2024-11-28"),label:"Thanksgiving"},{date:new Date("2024-10-31"),label:"Halloween"},{date:new Date("2024-02-14"),label:"Valentine's Day"}].filter(e=>{let t=new Date;return t.setHours(0,0,0,0),e.date>=t});return(0,a.jsxs)(l.Zp,{className:"w-full max-w-2xl mx-auto",children:[(0,a.jsxs)(l.aR,{children:[(0,a.jsx)(l.ZB,{children:"Select Important Dates"}),(0,a.jsx)(l.BT,{children:"Choose the dates that are most important to you for having your child. You'll then sort them by priority."})]}),(0,a.jsxs)(l.Wu,{className:"space-y-6",children:[t.length>0&&(0,a.jsxs)("div",{"data-testid":"selected-dates",children:[(0,a.jsxs)("h3",{className:"text-sm font-medium mb-2",children:["Selected Dates (",t.length,")"]}),(0,a.jsx)("div",{className:"space-y-2",children:t.map(e=>(0,a.jsxs)("div",{"data-testid":"selected-".concat(e.toISOString()),className:"flex items-center justify-between p-2 bg-blue-50 rounded-md",children:[(0,a.jsx)("span",{className:"text-sm",children:h(e)}),(0,a.jsx)(n.$,{variant:"ghost",size:"sm",onClick:()=>m(e),className:"text-red-600 hover:text-red-800",children:"Remove"})]},e.toISOString()))})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-sm font-medium mb-2",children:"Common Important Dates"}),(0,a.jsx)("div",{className:"grid grid-cols-2 gap-2",children:f.map(e=>{let r=t.some(t=>t.toISOString().split("T")[0]===e.date.toISOString().split("T")[0]);return(0,a.jsx)(n.$,{variant:r?"secondary":"outline",size:"sm",onClick:()=>p(e.date),disabled:r,className:"text-xs",children:e.label},e.date.toISOString())})})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-sm font-medium mb-2",children:"Add Custom Date"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{type:"date",value:c,onChange:e=>d(e.target.value),min:new Date().toISOString().split("T")[0],className:"flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm"}),(0,a.jsx)(n.$,{onClick:()=>{c&&(p(new Date(c)),d(""))},disabled:!c,size:"sm",children:"Add Date"})]})]}),(0,a.jsxs)("div",{className:"pt-4 border-t",children:[(0,a.jsx)(n.$,{"data-testid":"start-sorting",onClick:i,disabled:t.length<2,className:"w-full",size:"lg",children:t.length<2?"Select at least 2 dates to start sorting (".concat(t.length,"/2)"):"Start Sorting ".concat(t.length," Dates")}),t.length>=2&&(0,a.jsx)("p",{className:"text-xs text-gray-600 mt-2 text-center",children:"You'll compare dates to determine which are most important to you"})]})]})]})}var c=r(7926);function d(e){let{relationshipId:t,currentUserId:r,selectedDates:n=[],existingPreferences:l=[],holidayData:d={},onPreferencesUpdated:p}=e,[m,h]=(0,s.useState)(n),[f,u]=(0,s.useState)(!1),[y,g]=(0,s.useState)(!1),[x,w]=(0,s.useState)(null),b=e=>{let t=new Date;return t.setHours(0,0,0,0),e.filter(e=>{let r=new Date(e);return r.setHours(0,0,0,0),r>=t})},S=async e=>{g(!0),w(null);try{let a=e.map((e,t)=>({date:e.id,priority:t+1}));await c.t.saveDatePreferences(r,t,a),u(!1),p&&p()}catch(e){w("Error saving preferences. Please try again."),console.error("Error saving date preferences:",e)}finally{g(!1)}},_=()=>{u(!1)};if(f){let e=(e=>{let t=b(e).map(e=>{let t=e.toISOString().split("T")[0],r=d[t];return{id:t,label:r||e.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),description:r?e.toLocaleDateString():void 0,metadata:{date:t,isHoliday:!!r}}});if(l.length>0){let e=new Map(l.map(e=>[e.date,e.priority]));t.sort((t,r)=>(e.get(t.id)||999)-(e.get(r.id)||999))}return t})(m);return e.length<2?(0,a.jsxs)("div",{className:"text-center p-8",children:[(0,a.jsx)("h2",{className:"text-xl font-semibold mb-4",children:"No Future Dates to Sort"}),(0,a.jsx)("p",{className:"text-gray-600 mb-4",children:"All selected dates are in the past. Please select future dates to sort."}),(0,a.jsx)("button",{onClick:_,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Back to Date Selection"})]}):(0,a.jsxs)("div",{className:"space-y-4",children:[x&&(0,a.jsx)("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md",children:x}),(0,a.jsx)(i.S,{items:e,onSortComplete:S,title:"Sort Your Date Preferences",description:"Compare pairs of dates to determine which are most important to you for having your child."}),y&&(0,a.jsx)("div",{className:"text-center py-4",children:(0,a.jsxs)("div",{className:"inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-blue-500",children:[(0,a.jsxs)("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[(0,a.jsx)("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),(0,a.jsx)("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Saving preferences..."]})}),(0,a.jsx)("div",{className:"text-center",children:(0,a.jsx)("button",{onClick:_,className:"text-blue-600 hover:text-blue-800 text-sm",disabled:y,children:"← Back to Date Selection"})})]})}return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold mb-2",children:"Date Preference Sorting"}),(0,a.jsx)("p",{className:"text-gray-600",children:"Select important dates and sort them by priority to help with custody scheduling."})]}),(0,a.jsx)(o,{selectedDates:m,onDatesChange:h,onStartSorting:()=>{u(!0)},holidayData:d}),l.length>0&&(0,a.jsxs)("div",{className:"bg-blue-50 border border-blue-200 rounded-md p-4",children:[(0,a.jsx)("h3",{className:"font-medium text-blue-900 mb-2",children:"Your Current Preferences"}),(0,a.jsx)("div",{className:"space-y-1",children:l.sort((e,t)=>e.priority-t.priority).map((e,t)=>{let r=d[e.date],s=new Date(e.date),i=r||s.toLocaleDateString();return(0,a.jsxs)("div",{className:"text-sm text-blue-800",children:[t+1,". ",i]},e.date)})})]})]})}},7926:(e,t,r)=>{r.d(t,{t:()=>i});var a=r(2099);class s{async getUserPreferences(e,t){try{let{data:r,error:a}=await this.supabase.from("day_preferences").select("*").eq("parent_id",e).eq("relationship_id",t).order("priority",{ascending:!0});if(a)throw a;let{data:s,error:i}=await this.supabase.from("date_preferences").select("*").eq("parent_id",e).eq("relationship_id",t).order("priority",{ascending:!0});if(i)throw i;let{data:n,error:l}=await this.supabase.from("handoff_times").select("*").eq("relationship_id",t).order("time",{ascending:!0});if(l)throw l;return{dayPreferences:r||[],datePreferences:s||[],handoffTimes:n||[]}}catch(e){if(console.error("PreferenceService: Error fetching user preferences:",e),e instanceof Error&&(e.message.includes("Failed to fetch")||e.message.includes("Network")))throw Error("Network error. Please check your internet connection and try again.");throw Error("Failed to fetch user preferences. Please try again later.")}}async saveDayPreferences(e,t,r){try{let{error:a}=await this.supabase.from("day_preferences").delete().eq("parent_id",e).eq("relationship_id",t);if(a)throw a;let s=r.map(r=>({relationship_id:t,parent_id:e,day_of_week:r.dayOfWeek,priority:r.priority})),{data:i,error:n}=await this.supabase.from("day_preferences").insert(s).select();if(n)throw n;return i||[]}catch(e){throw console.error("Error saving day preferences:",e),Error("Failed to save day preferences")}}async saveDatePreferences(e,t,r){try{let{error:a}=await this.supabase.from("date_preferences").delete().eq("parent_id",e).eq("relationship_id",t);if(a)throw a;let s=r.map(r=>({relationship_id:t,parent_id:e,date:r.date,priority:r.priority})),{data:i,error:n}=await this.supabase.from("date_preferences").insert(s).select();if(n)throw n;return i||[]}catch(e){throw console.error("Error saving date preferences:",e),Error("Failed to save date preferences")}}async saveHandoffTimePreferences(e,t){try{let{error:r}=await this.supabase.from("handoff_times").delete().eq("relationship_id",e);if(r)throw r;let a=t.map(t=>({relationship_id:e,time:t.time,priority_parent_a:t.priorityParentA,priority_parent_b:t.priorityParentB})),{data:s,error:i}=await this.supabase.from("handoff_times").insert(a).select();if(i)throw i;return s||[]}catch(e){throw console.error("Error saving handoff time preferences:",e),Error("Failed to save handoff time preferences")}}async getRelationshipPreferenceSummary(e){try{let{data:t,error:r}=await this.supabase.from("co_parent_relationships").select("parent_a_id, parent_b_id").eq("id",e).single();if(r)throw r;let a=await this.getUserPreferenceSummary(t.parent_a_id,e),s=await this.getUserPreferenceSummary(t.parent_b_id,e);return{parentA:a,parentB:s}}catch(e){return console.error("Error fetching relationship preference summary:",e),{parentA:null,parentB:null}}}async getUserPreferenceSummary(e,t){try{let r=await this.getUserPreferences(e,t),a=r.dayPreferences.sort((e,t)=>e.priority-t.priority).map(e=>e.day_of_week),s=r.handoffTimes.map(r=>({time:r.time,priority:e===t?r.priority_parent_a:r.priority_parent_b})).sort((e,t)=>e.priority-t.priority).map(e=>e.time),i=r.datePreferences.sort((e,t)=>e.priority-t.priority).map(e=>e.date),n=[...r.dayPreferences.map(e=>e.updated_at),...r.datePreferences.map(e=>e.updated_at),...r.handoffTimes.map(e=>e.updated_at)],l=n.length>0?n.sort().reverse()[0]:new Date().toISOString();return{userId:e,relationshipId:t,preferredDays:a,preferredTimes:s,importantDates:i,lastUpdated:l}}catch(e){return console.error("Error getting user preference summary:",e),null}}async hasPreferences(e,t){try{let r=await this.getUserPreferences(e,t);return r.dayPreferences.length>0||r.datePreferences.length>0||r.handoffTimes.length>0}catch(e){return console.error("Error checking if preferences exist:",e),!1}}async getPreferenceConflicts(e){try{let t=await this.getRelationshipPreferenceSummary(e);if(!t.parentA||!t.parentB)return{dayConflicts:[],timeConflicts:[],dateConflicts:[]};let r=[];for(let e=0;e<=6;e++){let a=t.parentA.preferredDays.indexOf(e),s=t.parentB.preferredDays.indexOf(e);-1!==a&&-1!==s&&a<3&&s<3&&r.push({day:e,parentAPrefs:a+1,parentBPrefs:s+1})}let a=[];for(let e of t.parentA.preferredTimes.filter(e=>t.parentB.preferredTimes.includes(e))){let r=t.parentA.preferredTimes.indexOf(e),s=t.parentB.preferredTimes.indexOf(e);a.push({time:e,parentAPrefs:r+1,parentBPrefs:s+1})}let s=[];for(let e of t.parentA.importantDates.filter(e=>t.parentB.importantDates.includes(e)))s.push({date:e,bothWant:!0});return{dayConflicts:r,timeConflicts:a,dateConflicts:s}}catch(e){return console.error("Error analyzing preference conflicts:",e),{dayConflicts:[],timeConflicts:[],dateConflicts:[]}}}constructor(e=!1){e?this.supabase=null:this.supabase=(0,a.k)()}}let i=new s}}]);