"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[715],{2099:(e,t,s)=>{s.d(t,{H:()=>n,k:()=>i});var a=s(4982),r=s(9509);let i=()=>{let e="https://gjgldkinpnckfwzwdbmt.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqZ2xka2lucG5ja2Z3endkYm10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0OTczMDYsImV4cCI6MjA2NzA3MzMwNn0.5ZQourcUdjk19MWjLQ9O0VhcHJj09YPzcxbN35MfMtQ";return e&&t?(0,a.UU)(e,t):(console.warn("Supabase environment variables not found, using fallback values for static generation"),(0,a.UU)("https://placeholder.supabase.co","placeholder-anon-key"))},n=()=>{let e="https://gjgldkinpnckfwzwdbmt.supabase.co",t=r.env.SUPABASE_SERVICE_ROLE_KEY;return e&&t?(0,a.UU)(e,t,{auth:{autoRefreshToken:!1,persistSession:!1}}):(console.warn("Supabase service role environment variables not found, using fallback values for static generation"),(0,a.UU)("https://placeholder.supabase.co","placeholder-service-role-key",{auth:{autoRefreshToken:!1,persistSession:!1}}))}},3715:(e,t,s)=>{s.d(t,{OJ:()=>l,As:()=>c});var a=s(5155),r=s(2115),i=s(2099);class n{getSupabase(){return this.supabase||(this.supabase=(0,i.k)()),this.supabase}getAdminClient(){return this.adminClient||(this.adminClient=(0,i.H)()),this.adminClient}async createGuestUser(){try{let e="guest_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),t="".concat(e).concat(n.GUEST_EMAIL_DOMAIN),s=this.generateSecurePassword(),{data:a,error:r}=await this.getAdminClient().auth.admin.createUser({email:t,password:s,email_confirm:!0,user_metadata:{full_name:"Guest User",is_guest:!0,created_via:"guest_mode",session_expires_at:new Date(Date.now()+n.GUEST_SESSION_DURATION).toISOString()}});if(r)throw r;if(!a.user)throw Error("Failed to create guest user");let{error:i}=await this.getAdminClient().from("users").insert({id:a.user.id,email:t,full_name:"Guest User",credit_score:100});if(i)throw i;let{data:o,error:u}=await this.getSupabase().auth.signInWithPassword({email:t,password:s});if(u)throw u;if(!o.session||!o.user)throw Error("Failed to create guest session");return{user:{id:a.user.id,email:t,full_name:"Guest User",is_guest:!0,created_at:a.user.created_at,session_expires_at:a.user.user_metadata.session_expires_at},access_token:o.session.access_token,refresh_token:o.session.refresh_token,expires_at:o.session.expires_at||0}}catch(e){throw Error("Failed to create guest user: ".concat(e instanceof Error?e.message:"Unknown error"))}}async convertGuestToPermanentUser(e,t,s,a){try{let{data:r,error:i}=await this.getAdminClient().auth.admin.updateUserById(e,{email:t,password:s,email_confirm:!1,user_metadata:{full_name:a,is_guest:!1,converted_from_guest:!0,converted_at:new Date().toISOString()}});if(i)throw i;let{data:n,error:o}=await this.getAdminClient().from("users").update({email:t,full_name:a}).eq("id",e).select().single();if(o)throw o;let{error:u}=await this.getSupabase().auth.resend({type:"signup",email:t});return u&&console.warn("Failed to send confirmation email:",u),n}catch(e){throw Error("Failed to convert guest user: ".concat(e instanceof Error?e.message:"Unknown error"))}}async isGuestUser(){try{var e;let{data:{user:t}}=await this.getSupabase().auth.getUser();return(null==t||null==(e=t.user_metadata)?void 0:e.is_guest)===!0}catch(e){return!1}}async getGuestSessionExpiration(){try{var e;let{data:{user:t}}=await this.getSupabase().auth.getUser();if(!(null==t||null==(e=t.user_metadata)?void 0:e.is_guest))return null;let s=t.user_metadata.session_expires_at;return s?new Date(s):null}catch(e){return null}}async isGuestSessionExpired(){let e=await this.getGuestSessionExpiration();return!!e&&Date.now()>e.getTime()}async cleanupExpiredGuestUsers(){let e={deleted:0,errors:[]};try{let{data:t,error:s}=await this.getAdminClient().from("users").select("id, email").like("email","%".concat(n.GUEST_EMAIL_DOMAIN)).lt("created_at",new Date(Date.now()-n.GUEST_SESSION_DURATION).toISOString());if(s)throw s;for(let s of t||[])try{let{error:t}=await this.getAdminClient().auth.admin.deleteUser(s.id);if(t)throw t;e.deleted++}catch(t){e.errors.push("Failed to delete user ".concat(s.id,": ").concat(t instanceof Error?t.message:"Unknown error"))}}catch(t){e.errors.push("Cleanup failed: ".concat(t instanceof Error?t.message:"Unknown error"))}return e}async getGuestAnalytics(){try{let e=new Date(Date.now()-n.GUEST_SESSION_DURATION),{count:t}=await this.getAdminClient().from("users").select("*",{count:"exact",head:!0}).like("email","%".concat(n.GUEST_EMAIL_DOMAIN)),{count:s}=await this.getAdminClient().from("users").select("*",{count:"exact",head:!0}).like("email","%".concat(n.GUEST_EMAIL_DOMAIN)).gte("created_at",e.toISOString()),{count:a}=await this.getAdminClient().from("users").select("*",{count:"exact",head:!0}).not("email","like","%".concat(n.GUEST_EMAIL_DOMAIN));return{totalGuestUsers:t||0,activeGuestUsers:s||0,conversionRate:100*(t?(a||0)/t:0),averageSessionDuration:n.GUEST_SESSION_DURATION/36e5}}catch(e){return console.error("Failed to get guest analytics:",e),{totalGuestUsers:0,activeGuestUsers:0,conversionRate:0,averageSessionDuration:0}}}generateSecurePassword(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*",t="";for(let s=0;s<16;s++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}constructor(){this.supabase=null,this.adminClient=null}}n.GUEST_SESSION_DURATION=864e5,n.GUEST_EMAIL_DOMAIN="@guest.coparent.online";let o=new n,u=(0,r.createContext)(void 0);function l(e){let{children:t}=e,[s,n]=(0,r.useState)({user:null,isLoading:!0,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!1}),l=(0,i.k)();(0,r.useEffect)(()=>{if(!l)return;c();let{data:{subscription:e}}=l.auth.onAuthStateChange(async(e,t)=>{"SIGNED_IN"===e&&(null==t?void 0:t.user)?await d(t.user.id):"SIGNED_OUT"===e&&n({user:null,isLoading:!1,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!1})});return()=>e.unsubscribe()},[]);let c=async()=>{if(l)try{let{data:{session:e}}=await l.auth.getSession();(null==e?void 0:e.user)?await d(e.user.id):n(e=>({...e,isLoading:!1}))}catch(e){console.error("Failed to initialize auth:",e),n(e=>({...e,isLoading:!1}))}},d=async e=>{if(l)try{let{data:t,error:s}=await l.from("users").select("*").eq("id",e).single();if(s)throw s;let a=await o.isGuestUser(),r=a?await o.getGuestSessionExpiration():null;n({user:t,isLoading:!1,isGuest:a,guestSessionExpiration:r,isAuthenticated:!0}),a&&r&&Date.now()>r.getTime()&&await w()}catch(e){console.error("Failed to load user profile:",e),n({user:null,isLoading:!1,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!1})}},h=async(e,t)=>{if(!l)throw Error("Supabase client not available");try{n(e=>({...e,isLoading:!0}));let{data:s,error:a}=await l.auth.signInWithPassword({email:e,password:t});if(a)throw a;if(!s.user)throw Error("No user returned from sign in");await d(s.user.id)}catch(e){throw n(e=>({...e,isLoading:!1})),e}},g=async(e,t,s)=>{if(!l)throw Error("Supabase client not available");try{n(e=>({...e,isLoading:!0}));let{data:a,error:r}=await l.auth.signUp({email:e,password:t,options:{data:{full_name:s}}});if(r)throw r;if(!a.user)throw Error("No user returned from sign up");let{error:i}=await l.from("users").insert({id:a.user.id,email:e,full_name:s,credit_score:100});if(i)throw i;await d(a.user.id)}catch(e){throw n(e=>({...e,isLoading:!1})),e}},w=async()=>{if(l)try{await l.auth.signOut(),n({user:null,isLoading:!1,isGuest:!1,guestSessionExpiration:null,isAuthenticated:!1})}catch(e){console.error("Failed to sign out:",e)}},m=async()=>{try{n(e=>({...e,isLoading:!0})),await o.createGuestUser()}catch(e){throw n(e=>({...e,isLoading:!1})),e}},f=async(e,t,a)=>{try{if(!s.user||!s.isGuest)throw Error("No guest user to convert");n(e=>({...e,isLoading:!0}));let r=await o.convertGuestToPermanentUser(s.user.id,e,t,a);n(e=>({...e,user:r,isGuest:!1,guestSessionExpiration:null,isLoading:!1}))}catch(e){throw n(e=>({...e,isLoading:!1})),e}},_=async()=>{if(l)try{var e;let{data:t,error:s}=await l.auth.refreshSession();if(s)throw s;(null==(e=t.session)?void 0:e.user)&&await d(t.session.user.id)}catch(e){console.error("Failed to refresh session:",e),await w()}},S={...s,signIn:h,signUp:g,signOut:w,startGuestSession:m,convertGuestToUser:f,refreshSession:_};return(0,a.jsx)(u.Provider,{value:S,children:t})}function c(){let e=(0,r.useContext)(u);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}}}]);