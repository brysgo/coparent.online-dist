"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[122],{4383:(e,t,a)=>{a.d(t,{Y:()=>s});var n=a(9509);class i{async sendInvitationEmail(e){let t="Co-parenting invitation from ".concat(e.inviter_name),a=this.generateInvitationEmailContent(e);console.log("--- EMAIL WOULD BE SENT ---"),console.log("To: ".concat(e.invitee_email)),console.log("From: ".concat(e.inviter_email)),console.log("Subject: ".concat(t)),console.log("Content:\n".concat(a)),console.log("--- END EMAIL ---")}async sendEmail(e,t,a){console.log("--- EMAIL WOULD BE SENT ---"),console.log("To: ".concat(e)),console.log("Subject: ".concat(t)),console.log("Content:\n".concat(a)),console.log("--- END EMAIL ---")}generateInvitationEmailContent(e){let t="".concat(n.env.NEXT_PUBLIC_SITE_URL||"http://localhost:3000","/invite?code=").concat(e.invitation_code);return"\nHi there!\n\n".concat(e.inviter_name," (").concat(e.inviter_email,") has invited you to join CoParent.Online to co-parent ").concat(e.child_name,".\n\nBenefits of joining CoParent.Online:\n• Share schedules and coordinate custody seamlessly\n• Track shared expenses and manage finances together  \n• Manage your child's inventory and belongings\n• Communicate effectively through our platform\n• Access mediation tools for resolving conflicts\n\n").concat(e.message?"Personal message from ".concat(e.inviter_name,':\n"').concat(e.message,'"\n\n'):"","\n\nTo accept this invitation, click the link below:\n").concat(t,"\n\nThis invitation will expire on ").concat(new Date(e.expires_at).toLocaleDateString(),".\n\nIf you already have an account, simply log in and the invitation will be processed automatically.\n\nIf you don't have an account yet, you'll be guided through a quick signup process.\n\nBest regards,\nThe CoParent.Online Team\n\n---\nIf you did not expect this invitation or believe this was sent in error, you can safely ignore this email.\n    ").trim()}}function s(){return new i}},7122:(e,t,a)=>{a.d(t,{b:()=>l});var n=a(5155),i=a(2115),s=a(8417),o=a(285),r=a(6695),c=a(4899);function l(e){var t;let{situation:a,currentUserId:l,onResponseSent:d,isGuestMode:u=!1}=e,[m,p]=(0,i.useState)(!1),[g,h]=(0,i.useState)(null),[y,_]=(0,i.useState)(""),[f,v]=(0,i.useState)(""),w=async e=>{if(!m){p(!0),h(e);try{let t={situationId:a.id,userId:l,responseType:e,message:y||void 0,estimatedArrival:f?new Date(f):void 0};if(u){c.B.saveGuestInteraction("demo_action",{type:"emergency_quick_response",situationId:a.id,responseType:e,message:y,source:"quick_response"});let n={id:"qr_".concat(Date.now()),timestamp:new Date,...t};d&&d(n)}else await s.N.sendQuickResponse(a.id,t);_(""),v(""),h(null)}catch(e){console.error("Error sending quick response:",e)}finally{p(!1)}}};return(0,n.jsx)(r.Zp,{className:"border-l-4 border-l-red-500",children:(0,n.jsxs)(r.Wu,{className:"p-6",children:[(0,n.jsxs)("div",{className:"flex items-start justify-between mb-4",children:[(0,n.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,n.jsx)("div",{className:"flex-shrink-0",children:(0,n.jsx)("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center",children:(0,n.jsx)("svg",{className:"w-6 h-6 text-red-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,n.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"})})})}),(0,n.jsxs)("div",{children:[(0,n.jsxs)("h3",{className:"text-lg font-semibold text-gray-900",children:["\uD83D\uDEA8 ",a.title]}),(0,n.jsxs)("p",{className:"text-sm text-gray-600",children:[(e=>{let t=Math.floor((new Date().getTime()-e.getTime())/6e4);if(t<1)return"Just now";if(t<60)return"".concat(t,"m ago");let a=Math.floor(t/60);if(a<24)return"".concat(a,"h ago");let n=Math.floor(a/24);return"".concat(n,"d ago")})(a.createdAt)," • ",(null==(t=a.metadata.location)?void 0:t.name)||"Location not specified"]})]})]}),(0,n.jsxs)("div",{className:"px-3 py-1 rounded-full text-sm font-medium ".concat((e=>{switch(e){case 5:return"bg-red-600 text-white";case 4:return"bg-red-500 text-white";case 3:return"bg-orange-500 text-white";case 2:return"bg-yellow-500 text-white";case 1:return"bg-blue-500 text-white";default:return"bg-gray-500 text-white"}})(a.metadata.urgencyLevel)),children:["Level ",a.metadata.urgencyLevel]})]}),(0,n.jsxs)("div",{className:"mb-6 p-4 bg-gray-50 rounded-lg",children:[(0,n.jsx)("p",{className:"text-gray-800 mb-2",children:a.description}),a.metadata.location&&(0,n.jsxs)("div",{className:"text-sm text-gray-600",children:[(0,n.jsx)("span",{className:"font-medium",children:"Location:"})," ",a.metadata.location.address]}),a.metadata.requiresPickup&&(0,n.jsx)("div",{className:"text-sm text-orange-600 font-medium mt-1",children:"⚠️ Pickup required"}),a.metadata.requiresMedicalAttention&&(0,n.jsx)("div",{className:"text-sm text-red-600 font-medium mt-1",children:"\uD83C\uDFE5 Medical attention needed"})]}),(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsx)("h4",{className:"font-medium text-gray-900",children:"Quick Response:"}),(0,n.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:[{type:"acknowledged",label:"Acknowledged",icon:"✓",description:"I see this emergency",color:"bg-blue-100 text-blue-800 hover:bg-blue-200"},{type:"on_way",label:"On My Way",icon:"\uD83D\uDE97",description:"I'm heading there now",color:"bg-green-100 text-green-800 hover:bg-green-200"},{type:"handled",label:"Handled",icon:"✅",description:"Situation is resolved",color:"bg-green-100 text-green-800 hover:bg-green-200"},{type:"need_help",label:"Need Help",icon:"\uD83C\uDD98",description:"I need additional assistance",color:"bg-orange-100 text-orange-800 hover:bg-orange-200"},{type:"cant_help",label:"Can't Help",icon:"❌",description:"I'm unable to assist",color:"bg-red-100 text-red-800 hover:bg-red-200"}].map(e=>(0,n.jsxs)(o.$,{variant:"outline",className:"h-auto p-4 flex flex-col items-center space-y-2 ".concat(e.color," ").concat(g===e.type?"ring-2 ring-blue-500":""),onClick:()=>w(e.type),disabled:m,children:[(0,n.jsx)("span",{className:"text-2xl",children:e.icon}),(0,n.jsxs)("div",{className:"text-center",children:[(0,n.jsx)("div",{className:"font-medium",children:e.label}),(0,n.jsx)("div",{className:"text-xs opacity-75",children:e.description})]})]},e.type))}),("on_way"===g||"need_help"===g||"cant_help"===g)&&(0,n.jsxs)("div",{className:"space-y-3 p-4 bg-blue-50 rounded-lg",children:["on_way"===g&&(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Estimated Arrival Time"}),(0,n.jsx)("input",{type:"datetime-local",value:f,onChange:e=>v(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",min:new Date().toISOString().slice(0,16)})]}),(0,n.jsxs)("div",{children:[(0,n.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Additional Message (Optional)"}),(0,n.jsx)("textarea",{value:y,onChange:e=>_(e.target.value),placeholder:"Add any additional details...",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent",rows:2})]})]}),m&&(0,n.jsxs)("div",{className:"flex items-center justify-center py-4",children:[(0,n.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"}),(0,n.jsx)("span",{className:"ml-2 text-gray-600",children:"Sending response..."})]})]}),(0,n.jsx)("div",{className:"mt-6 pt-4 border-t border-gray-200",children:(0,n.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,n.jsxs)(o.$,{variant:"outline",size:"sm",children:["\uD83D\uDCDE Call ",a.assignedTo[0]||"Parent"]}),(0,n.jsx)(o.$,{variant:"outline",size:"sm",children:"\uD83D\uDCCD Get Directions"}),a.metadata.urgencyLevel>=4&&(0,n.jsx)(o.$,{variant:"outline",size:"sm",className:"text-red-600 border-red-300 hover:bg-red-50",children:"\uD83D\uDEA8 Call 911"})]})}),u&&(0,n.jsx)("div",{className:"mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:(0,n.jsxs)("p",{className:"text-sm text-blue-700",children:[(0,n.jsx)("span",{className:"font-medium",children:"Demo Mode:"})," In a real emergency, your response would immediately notify all involved parties and update the situation status."]})})]})})}},8417:(e,t,a)=>{a.d(t,{N:()=>s,h:()=>i});var n=a(8498);class i extends n.W{async createEmergency(e){let t={...e,priority:"urgent",status:"created"},a=await this.createSituation(t),n=this.calculateEstimatedResolutionTime(a.metadata.urgencyLevel);return a.metadata={...a.metadata,estimatedResolutionTime:n},await this.sendImmediateNotifications(a),await this.scheduleEmergencyEscalation(a),a}async sendQuickResponse(e,t){let a=this.getSituation(e);if(!a)throw Error("Situation ".concat(e," not found"));let n={id:this.generateId(),timestamp:new Date,...t};this.quickResponses.has(e)||this.quickResponses.set(e,[]),this.quickResponses.get(e).push(n),await this.handleQuickResponseUpdate(a,n),await this.addUpdate(e,{userId:n.userId,type:"comment",content:this.formatQuickResponseMessage(n),metadata:{responseType:n.responseType,estimatedArrival:n.estimatedArrival,location:n.location}}),await this.notifyQuickResponse(a,n)}async trackLocation(e,t,a){this.locationTracking.has(e)||this.locationTracking.set(e,new Map),this.locationTracking.get(e).set(t,a),await this.addUpdate(e,{userId:t,type:"comment",content:"Location updated: ".concat(a[0].toFixed(6),", ").concat(a[1].toFixed(6)),metadata:{location:a,locationType:"gps_update"}})}async escalateToEmergencyContacts(e){let t=this.getSituation(e);if(!t)throw Error("Emergency situation ".concat(e," not found"));let a=t.metadata.emergencyContacts||[];if(0===a.length)return void console.warn("No emergency contacts configured for situation ".concat(e));await this.escalateSituation(e,"No response from assigned parties - escalating to emergency contacts"),await this.notifyEmergencyContacts(t,a),t.metadata.urgencyLevel>=4&&await this.handleHighUrgencyEscalation(t)}async getActiveEmergencies(e){return(await this.getSituations({type:["emergency"],status:["created","acknowledged","in-progress","escalated"]})).filter(t=>t.involvedParties.includes(e)||t.assignedTo.includes(e))}getQuickResponses(e){return this.quickResponses.get(e)||[]}getLocationTracking(e){return this.locationTracking.get(e)||new Map}requiresImmediateEscalation(e){let{urgencyLevel:t,requiresMedicalAttention:a}=e.metadata;return!!(5===t||a&&t>=3||e.deadline&&e.deadline.getTime()-Date.now()<9e5)||!1}calculateEstimatedResolutionTime(e){switch(e){case 5:return 15;case 4:return 30;case 3:default:return 60;case 2:return 120;case 1:return 240}}async sendImmediateNotifications(e){var t;console.log("\uD83D\uDEA8 EMERGENCY NOTIFICATION: ".concat(e.title)),console.log("Assigned to: ".concat(e.assignedTo.join(", "))),console.log("Urgency Level: ".concat(e.metadata.urgencyLevel,"/5")),console.log("Location: ".concat((null==(t=e.metadata.location)?void 0:t.name)||"Not specified"))}async scheduleEmergencyEscalation(e){let t=this.getEscalationDelay(e);console.log("Scheduling emergency escalation for situation ".concat(e.id," in ").concat(t," minutes"))}getEscalationDelay(e){let{urgencyLevel:t}=e.metadata;switch(t){case 5:return 5;case 4:return 10;case 3:default:return 15;case 2:return 30;case 1:return 60}}async handleQuickResponseUpdate(e,t){let a=e.status;switch(t.responseType){case"acknowledged":"created"===e.status&&(a="acknowledged");break;case"on_way":a="in-progress";break;case"handled":a="resolved";break;case"need_help":await this.escalateToEmergencyContacts(e.id);break;case"cant_help":await this.handleCannotHelp(e,t)}a!==e.status&&await this.updateSituation(e.id,{status:a})}formatQuickResponseMessage(e){let t={acknowledged:"Acknowledged the emergency",on_way:"On my way",handled:"Situation handled",need_help:"Need additional help",cant_help:"Cannot help with this emergency"}[e.responseType];return e.estimatedArrival&&(t+=" - ETA: ".concat(e.estimatedArrival.toLocaleTimeString())),e.message&&(t+=" - ".concat(e.message)),t}async notifyQuickResponse(e,t){let a=e.involvedParties.filter(e=>e!==t.userId);console.log("Notifying parties about quick response: ".concat(a.join(", "))),console.log("Response: ".concat(this.formatQuickResponseMessage(t)))}async notifyEmergencyContacts(e,t){console.log("\uD83D\uDEA8 ESCALATING TO EMERGENCY CONTACTS: ".concat(t.join(", "))),console.log("Emergency: ".concat(e.title)),console.log("Urgency: ".concat(e.metadata.urgencyLevel,"/5"))}async handleHighUrgencyEscalation(e){if(5===e.metadata.urgencyLevel){var t;console.log("⚠️  LEVEL 5 EMERGENCY - Consider calling 911"),console.log("Emergency: ".concat(e.title)),console.log("Location: ".concat((null==(t=e.metadata.location)?void 0:t.address)||"Unknown"))}await this.addUpdate(e.id,{userId:"system",type:"escalation",content:"High urgency emergency (Level ".concat(e.metadata.urgencyLevel,") - Additional safety protocols activated"),metadata:{urgencyLevel:e.metadata.urgencyLevel,autoEscalation:!0}})}async handleCannotHelp(e,t){let a=e.involvedParties.filter(a=>a!==t.userId&&!e.assignedTo.includes(a));a.length>0?(await this.updateSituation(e.id,{assignedTo:[...e.assignedTo,...a]}),await this.addUpdate(e.id,{userId:"system",type:"status_change",content:"Reassigned to additional parties: ".concat(a.join(", ")),metadata:{reassignment:!0,originalResponder:t.userId}})):await this.escalateToEmergencyContacts(e.id)}constructor(...e){super(...e),this.quickResponses=new Map,this.locationTracking=new Map}}let s=new i},8498:(e,t,a)=>{a.d(t,{W:()=>r});var n=a(4383),i=a(9509);class s{getDefaultPreferences(e){let t=[],a=1;return["schedule_change","expense_added","emergency","invitation","reminder","situation_created","situation_updated","situation_escalated"].forEach(n=>{t.push({id:"pref-".concat(a++),user_id:e,event_type:n,channel:"email",enabled:!0,quiet_hours_start:"22:00",quiet_hours_end:"08:00",emergency_override:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),["emergency","situation_escalated"].includes(n)?t.push({id:"pref-".concat(a++),user_id:e,event_type:n,channel:"push",enabled:!0,quiet_hours_start:"22:00",quiet_hours_end:"08:00",emergency_override:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}):t.push({id:"pref-".concat(a++),user_id:e,event_type:n,channel:"push",enabled:!1,quiet_hours_start:"22:00",quiet_hours_end:"08:00",emergency_override:!0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()})}),t}shouldSendNotification(e,t){if(e.emergency_override&&("emergency"===t.event_type||"situation_escalated"===t.event_type||"urgent"===t.priority))return!0;if(e.quiet_hours_start&&e.quiet_hours_end){let t=new Date().toTimeString().slice(0,5);if(this.isInQuietHours(t,e.quiet_hours_start,e.quiet_hours_end))return!1}return!0}isInQuietHours(e,t,a){return t>a?e>=t||e<=a:e>=t&&e<=a}async sendNotification(e){try{let t=this.getDefaultPreferences(e.user_id);console.log("Client notification service - would send notification:",e);let a=t.filter(t=>t.event_type===e.event_type&&t.enabled);if(0===a.length)return console.log("No enabled preferences for event type:",e.event_type),!1;for(let t of a)if(this.shouldSendNotification(t,e)&&(console.log("Would send ".concat(t.channel," notification for ").concat(e.event_type)),"email"===t.channel)){let a=this.getNotificationTemplate(e.event_type,t.channel),{subject:n,content:i}=this.renderTemplate(a,e.data);await this.emailService.sendEmail("user@example.com",n,i)}return!0}catch(e){return console.error("Error sending notification:",e),!1}}getNotificationTemplate(e,t){let a="".concat(e,"_").concat(t);return({["schedule_change_".concat(t)]:{event_type:"schedule_change",channel:t,subject_template:"Schedule Change Request from {{co_parent_name}}",content_template:"Hi {{user_name}},\n\n{{co_parent_name}} has requested a schedule change for {{child_name}}.\n\nOriginal: {{original_date}} at {{original_time}}\nProposed: {{proposed_date}} at {{proposed_time}}\n{{#reason}}\nReason: {{reason}}\n{{/reason}}\n\nPlease review and respond to this request:\n{{action_url}}\n\nBest regards,\nCoParent.Online Team",variables:["user_name","co_parent_name","child_name","original_date","original_time","proposed_date","proposed_time","reason","action_url"]},["emergency_".concat(t)]:{event_type:"emergency",channel:t,subject_template:"\uD83D\uDEA8 EMERGENCY: {{emergency_type}} - {{child_name}}",content_template:"EMERGENCY NOTIFICATION\n\nType: {{emergency_type}}\nChild: {{child_name}}\nLocation: {{location}}\n{{#description}}\nDetails: {{description}}\n{{/description}}\n\nReported by: {{reporter_name}}\nTime: {{timestamp}}\n\n{{#requires_pickup}}\n⚠️ PICKUP REQUIRED\n{{/requires_pickup}}\n\nRespond immediately: {{action_url}}",variables:["emergency_type","child_name","location","description","reporter_name","timestamp","requires_pickup","action_url"]},["situation_created_".concat(t)]:{event_type:"situation_created",channel:t,subject_template:"New {{situation_type}} situation: {{situation_title}}",content_template:"Hi there,\n\nA new {{situation_type}} situation has been created that requires your attention:\n\nTitle: {{situation_title}}\nDescription: {{situation_description}}\nPriority: {{priority}}\nCreated by: {{created_by}}\n\nPlease review the situation: {{action_url}}\n\nBest regards,\nCoParent.Online Team",variables:["situation_type","situation_title","situation_description","priority","created_by","action_url"]}})[a]||{event_type:e,channel:t,subject_template:"CoParent.Online Notification",content_template:"You have a new notification. Please check your dashboard.",variables:[]}}renderTemplate(e,t){let a=e.subject_template,n=e.content_template;return Object.keys(t).forEach(e=>{let i=t[e]||"",s=RegExp("{{".concat(e,"}}"),"g");a=a.replace(s,i),n=n.replace(s,i)}),n=n.replace(RegExp("{{#(\\w+)}}(.*?){{\\/\\1}}","gs"),(e,a,n)=>t[a]?n:""),{subject:a,content:n}}async notifyScheduleChange(e,t,a,n,s,o,r,c){return this.sendNotification({user_id:e,event_type:"schedule_change",data:{co_parent_name:t,child_name:a,original_date:n,original_time:s,proposed_date:o,proposed_time:r,reason:c,action_url:"".concat(i.env.NEXT_PUBLIC_SITE_URL||"http://localhost:3000","/schedule")}})}async notifyEmergency(e,t,a,n,s,o){let r=arguments.length>6&&void 0!==arguments[6]&&arguments[6];return this.sendNotification({user_id:e,event_type:"emergency",priority:"urgent",data:{emergency_type:t,child_name:a,location:n,description:o,reporter_name:s,timestamp:new Date().toLocaleString(),requires_pickup:r,action_url:"".concat(i.env.NEXT_PUBLIC_SITE_URL||"http://localhost:3000","/emergency")}})}async notifyExpenseAdded(e,t,a,n,s,o,r,c){return this.sendNotification({user_id:e,event_type:"expense_added",data:{co_parent_name:t,expense_title:a,amount:n.toFixed(2),date:s,category:o,your_share:r.toFixed(2),receipt_url:c,action_url:"".concat(i.env.NEXT_PUBLIC_SITE_URL||"http://localhost:3000","/expenses")}})}constructor(){this.emailService=(0,n.Y)()}}var o=a(9509);class r{async createSituation(e){let t=this.generateId(),a=new Date,n=this.getTemplate(e.type),i=this.determineAssignment(e,n),s=this.calculateDeadline(e,n),o={...e,id:t,createdAt:a,assignedTo:i,deadline:s,updates:[],escalations:[],priority:e.priority||(null==n?void 0:n.defaultPriority)||"medium",status:e.status||"created"};return this.situations.set(t,o),await this.addUpdate(t,{userId:o.createdBy,type:"status_change",content:"Situation created: ".concat(o.title),metadata:{status:"created"}}),await this.notifyAssignedParties(o),o}async updateSituation(e,t){let a=this.situations.get(e);if(!a)throw Error("Situation ".concat(e," not found"));let n={...a,...t};return this.situations.set(e,n),t.status&&t.status!==a.status&&await this.addUpdate(e,{userId:"system",type:"status_change",content:"Status changed from ".concat(a.status," to ").concat(t.status),metadata:{oldStatus:a.status,newStatus:t.status}}),n}async addUpdate(e,t){let a=this.situations.get(e);if(!a)throw Error("Situation ".concat(e," not found"));let n={id:this.generateId(),situationId:e,timestamp:new Date,...t};a.updates.push(n),this.situations.set(e,a)}async resolveSituation(e,t,a){let n=this.situations.get(e);if(!n)throw Error("Situation ".concat(e," not found"));await this.updateSituation(e,{status:"resolved",resolvedAt:new Date}),await this.addUpdate(e,{userId:"system",type:"status_change",content:"Situation resolved: ".concat(t),metadata:{resolution:t,...a}}),n.gamificationImpact&&await this.applyGamificationImpact(n)}async escalateSituation(e,t){let a=this.situations.get(e);if(!a)throw Error("Situation ".concat(e," not found"));let n=a.escalations.length+1,i={id:this.generateId(),situationId:e,level:n,reason:t,triggeredAt:new Date,triggeredBy:"user",actions:this.getEscalationActions(a,n),resolved:!1};a.escalations.push(i),await this.updateSituation(e,{status:"escalated",priority:this.increasePriority(a.priority)}),await this.addUpdate(e,{userId:"system",type:"escalation",content:"Situation escalated (Level ".concat(n,"): ").concat(t),metadata:{escalationLevel:n,reason:t}}),await this.executeEscalationActions(i)}async getSituations(e){let t=Array.from(this.situations.values());return e.relationshipId&&(t=t.filter(t=>t.relationshipId===e.relationshipId)),e.status&&(t=t.filter(t=>e.status.includes(t.status))),e.type&&(t=t.filter(t=>e.type.includes(t.type))),e.assignedTo&&(t=t.filter(t=>t.assignedTo.includes(e.assignedTo))),e.priority&&(t=t.filter(t=>e.priority.includes(t.priority))),t.sort((e,t)=>{let a={urgent:4,high:3,medium:2,low:1},n=a[e.priority],i=a[t.priority];return n!==i?i-n:t.createdAt.getTime()-e.createdAt.getTime()})}getSituation(e){return this.situations.get(e)}getOverdueSituations(){let e=new Date;return Array.from(this.situations.values()).filter(t=>t.deadline&&t.deadline<e&&!["resolved","cancelled"].includes(t.status))}getSituationsRequiringEscalation(){let e=Date.now();return Array.from(this.situations.values()).filter(t=>!["resolved","cancelled"].includes(t.status)&&!t.updates.some(e=>"status_change"===e.type&&e.content.includes("acknowledged"))&&e-t.createdAt.getTime()>("urgent"===t.priority?9e5:72e5))}initializeTemplates(){this.templates.set("emergency-pickup",{id:"emergency-pickup",type:"emergency",name:"Emergency School Pickup",description:"Child needs immediate pickup from school",defaultPriority:"urgent",defaultDeadlineHours:1,requiredFields:["location","emergencyType"],metadataSchema:{emergencyType:"pickup",requiresPickup:!0},autoAssignmentRules:[{condition:"emergency",assignTo:"both"}]}),this.templates.set("forgotten-item",{id:"forgotten-item",type:"logistics",name:"Forgotten Item",description:"Child forgot important item at other parent's house",defaultPriority:"medium",defaultDeadlineHours:24,requiredFields:["items"],metadataSchema:{logisticsType:"forgotten_item"},autoAssignmentRules:[{condition:"logistics",assignTo:"other_parent"}]}),this.templates.set("behavioral-incident",{id:"behavioral-incident",type:"behavioral",name:"Behavioral Incident",description:"Child behavioral issue requiring coordination",defaultPriority:"high",defaultDeadlineHours:48,requiredFields:["incident","childId"],metadataSchema:{behaviorType:"disciplinary",privacyLevel:"both_parents"},autoAssignmentRules:[{condition:"behavioral",assignTo:"both"}]})}getTemplate(e){return Array.from(this.templates.values()).find(t=>t.type===e)}determineAssignment(e,t){if(e.assignedTo&&e.assignedTo.length>0)return e.assignedTo;if(null==t?void 0:t.autoAssignmentRules)switch(t.autoAssignmentRules[0].assignTo){case"both":return e.involvedParties;case"other_parent":return e.involvedParties.filter(t=>t!==e.createdBy)}return[e.createdBy]}calculateDeadline(e,t){if(e.deadline)return e.deadline;if(null==t?void 0:t.defaultDeadlineHours){let e=new Date;return e.setHours(e.getHours()+t.defaultDeadlineHours),e}let a={urgent:2,high:24,medium:72,low:168}[e.priority||"medium"],n=new Date;return n.setHours(n.getHours()+a),n}increasePriority(e){let t=["low","medium","high","urgent"],a=Math.min(t.indexOf(e)+1,t.length-1);return t[a]}getEscalationActions(e,t){let a=[];switch(t){case 1:a.push("send_reminder","notify_assigned_parties");break;case 2:a.push("increase_priority","notify_emergency_contacts");break;case 3:a.push("create_follow_up_situation","notify_external_parties");break;default:a.push("manual_intervention_required")}return a}async executeEscalationActions(e){console.log("Executing escalation actions for situation ".concat(e.situationId,":"),e.actions)}async notifyAssignedParties(e){for(let a of(console.log("Notifying assigned parties for situation ".concat(e.id,":"),e.assignedTo),e.assignedTo))try{if("emergency"===e.type){var t;await this.notificationService.notifyEmergency(a,e.metadata.emergencyType,"Child",(null==(t=e.metadata.location)?void 0:t.name)||"Unknown location","Co-parent",e.description,e.metadata.requiresPickup)}else await this.notificationService.sendNotification({user_id:a,event_type:"urgent"===e.priority?"situation_escalated":"situation_created",data:{situation_type:e.type,situation_title:e.title,situation_description:e.description,priority:e.priority,created_by:e.createdBy,action_url:"".concat(o.env.NEXT_PUBLIC_SITE_URL,"/situations")}})}catch(t){console.error("Failed to notify user ".concat(a," about situation ").concat(e.id,":"),t)}}async applyGamificationImpact(e){e.gamificationImpact&&console.log("Applying gamification impact for situation ".concat(e.id,":"),e.gamificationImpact)}generateId(){return"sit_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))}constructor(){this.situations=new Map,this.templates=new Map,this.initializeTemplates(),this.notificationService=new s}}new r}}]);